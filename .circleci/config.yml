# Circle CI configuration file
# https://circleci.com/docs/

version: 2.1

#######################################
# Define some common steps as commands.
#
commands:
  apt-install:
    description: Install libraries needed by GUI components.
    steps:
      - run:
          name: Install apt packages
          command: |
            sudo apt -qq update
            sudo apt install--no-install-recommends -y \
              libgirepository1.0-dev \
              gir1.2-gtk-3.0 \
              python3-gi \
              python3-gi-cairo \
              python3-pytest \
              libenchant1c2a \
              libenchant-dev \
              xauth \
              xvfb

  pip-install:
    description: Upgrade pip and other Python packages to get as clean an install as possible.
    steps:
      - run:
          name: Upgrade pip, setuptools, wheel, etc.
          command: |
            python -mpip install --upgrade --user pip
            python -mpip install --upgrade --user wheel
            python -mpip install --upgrade --user setuptools
            python -mpip install --upgrade --user urllib3
            python -mpip install --upgrade --user pip-tools

  deps-install:
    steps:
      - run:
          name: Install RAMSTK dependencies
          command: |
            python -mpip install --user -r requirements.txt -r requirements-test.txt

  ramstk-install:
    steps:
      - run:
          name: Install RAMSTK
          command: python -mpip install --user -ve .

  make-coverage:
    steps:
      - run:
          name: Test with coverage
          command: make coverage

##########################################
# Define jobs.
#
jobs:
  test-with-coverage:
    docker:
      - image: circleci/python:3.7
        auth:
          username: weibullguy
          password: $DOCKERHUB_PASSWORD
        environment:
          TEST_DATABASE_URL: postgresql://root@localhost/TestProgramDB

    steps:
      - checkout
      - apt-install
      - pip-install
      - deps-install
      - ramstk-install
      - make-coverage

#########################################
# Define workflows.
#
workflows:
  version: 2
  build:
    jobs:
      - test-with-coverage
