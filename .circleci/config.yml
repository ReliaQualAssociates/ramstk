# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
jobs:
  build:
    working_directory: ~/rtk-python2.7-pygtk
    docker:
      # specify the version you desire here
      # use `-browsers` prefix for selenium tests, e.g. `3.6.1-browsers`

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/postgres:9.4
      - image: circleci/python:2.7

    steps:
      - checkout
      - dependencies:
        - pre:
            - sudo apt-get update
            - sudo apt-get install -yqq python-gtk2 python-gtk2-dev

      # Download and cache dependencies
      - restore_cache:
          keys:
          - deps-{{ .Branch }}-{{ checksum "requirements_run.txt" }}
          # fallback to using the latest cache if no exact match is found
          - deps-

      - run:
          command: |
            python -m venc venv
            . venv/bin/activate
            pip install -U pip
            pip install -U setuptools>12.0
            pip install --only-binary=numpy numpy==1.14.3
            pip install --only-binary=scipy scipy==1.0.0
            pip install coverage==4.0.3
            pip install -r requirements_run.txt
            pip install -r requirements_dev.txt
            pip install matplotlib==1.4.3

      - save_cache:
          key: deps-{{ .Branch }}-{{ checksum "requirements_run.txt" }}
          paths:
            - "venv"

      - run:
          command: |
            . venv/bin/activate
            python setup.py test

      - store_artifacts:
          path: test-reports/
          destination: test-reports
