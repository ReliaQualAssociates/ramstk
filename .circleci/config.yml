version: 2.1

orbs:
  python: circleci/python@0.2.1
  
jobs:
  build:
    docker:
      - image: circleci/python:3.7.4
        auth:
          username: weibullguy
          password: $DOCKERHUB_PASSWORD
        environment:
          TEST_DATABASE_URL: postgresql://root@localhost/TestProgramDB

    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install -y libgirepository1.0-dev gir1.2-gtk-3.0 python3-gi python3-gi-cairo python3-pytest libenchant1c2a libenchant-dev
      - run: pip install -U pip
      - run: pip install -U setuptools>12.0
      - run: pip install -U urllib3
      - run: pip install -U pip-tools
      - run: pip install -r requirements.txt -r requirements-test.txt

  test:
    docker:
      - image: circleci/python:3.7.4
        auth:
          username: weibullguy
          password: $DOCKERHUB_PASSWORD
        environment:
          TEST_DATABASE_URL: postgresql://root@localhost/TestProgramDB
    steps:
      - python/load-cache
      - python/save-cache
      - run: make coverage

workflows:
  build_and_test:
    jobs:
      - build
      - test
      
